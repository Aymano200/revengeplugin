(function(u,v,P,a,c,R,U){"use strict";const{View:d,StyleSheet:k,TouchableOpacity:E}=v.ReactNative,{FormInput:f,FormText:m,FormDivider:x}=R.Forms,s=k.create({container:{padding:16,flex:1},inputGroup:{marginBottom:16},button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginTop:16},buttonDisabled:{backgroundColor:"#4f545c"},buttonText:{color:"white",fontWeight:"bold"},description:{marginTop:24}});function $(){U.useProxy(a.storage);const e=async function(){i.stopPolling(),a.storage.serverUrl&&(a.storage.serverUrl=a.storage.serverUrl.trim().replace(/\/$/,"")),await i.authenticate()&&i.startPolling()},n=!a.storage.serverUrl||!a.storage.username||!a.storage.password;return React.createElement(d,{style:s.container},React.createElement(d,{style:s.inputGroup},React.createElement(m,null,"Server URL"),React.createElement(f,{placeholder:"https://abs.example.com",value:a.storage.serverUrl??"",onChange:function(o){return a.storage.serverUrl=o},autoCapitalize:"none",autoCorrect:!1})),React.createElement(d,{style:s.inputGroup},React.createElement(m,null,"Username"),React.createElement(f,{placeholder:"your ABS username",value:a.storage.username??"",onChange:function(o){return a.storage.username=o},autoCapitalize:"none",autoCorrect:!1})),React.createElement(d,{style:s.inputGroup},React.createElement(m,null,"Password"),React.createElement(f,{placeholder:"your ABS password",value:a.storage.password??"",onChange:function(o){return a.storage.password=o},secureTextEntry:!0})),React.createElement(E,{style:[s.button,n&&s.buttonDisabled],onPress:e,disabled:n},React.createElement(m,{style:s.buttonText},"Login")))}const y=P.findByProps("getAssetIds","fetchAssetIds"),b="1381423044907503636",S=5e3;let h,l=null,p=!1;function w(e){v.FluxDispatcher.dispatch({type:"LOCAL_ACTIVITY_UPDATE",activity:e,socketId:"ABSRPC"})}async function A(e){const{serverUrl:n,username:o,password:t}=a.storage;if(!n||!o||!t)return p||c.showToast("\u274C AudioBookShelf RPC not configured."),p=!0,!1;p=!0;try{const r=await fetch(`${n.replace(/\/$/,"")}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:o,password:t})});if(!r.ok)throw new Error(`Server responded with ${r.status}`);return l=(await r.json()).user?.token,l?(e?.success||c.showToast("\u2705 Logged in successfully."),!0):(c.showToast("\u274C AudioBookShelf login failed."),!1)}catch{return c.showToast("\u274C Login failed. Check debug logs."),!1}}async function T(){if(!l&&!await A({success:!0}))return null;try{const e=a.storage.serverUrl.replace(/\/$/,""),n=await fetch(`${e}/api/me/listening-sessions`,{headers:{Authorization:`Bearer ${l}`}});if(!n.ok)return n.status===401?(l=null,T()):null;const{sessions:o}=await n.json(),t=o.find(function(g){return g.updatedAt&&!g.isFinished});if(!t||Date.now()-t.updatedAt>1e4)return null;const r=t.mediaMetadata;return r?{name:r.title||"Unknown",type:t.mediaType||"book",author:r.authors?.map(function(g){return g.name}).join(", "),publisher:r.publisher,series:r.series?.[0]?.name,duration:t.duration,currentTime:t.currentTime,updatedAt:t.updatedAt,imageUrl:t.libraryItemId?`${e}/api/items/${t.libraryItemId}/cover`:void 0,isFinished:t.isFinished||!1}:null}catch{return w(null),null}}async function F(){const e=await T();if(!e||e.isFinished)return null;let n={large_image:e.imageUrl??"audiobookshelf",large_text:e.publisher||"Unknown Publisher"};try{const t=[b,[n.large_image]];let r=y.getAssetIds?.(...t);!r?.length&&y.fetchAssetIds&&(r=await y.fetchAssetIds(...t)),n.large_image=r?.[0]??n.large_image}catch{}const o=e.currentTime!=null&&e.duration&&e.updatedAt?{start:e.updatedAt-e.currentTime*1e3,end:e.updatedAt-e.currentTime*1e3+e.duration*1e3}:void 0;return{application_id:b,name:"AudioBookShelf",details:e.name,state:e.author||"Unknown Author",assets:n,timestamps:o,type:2,flags:1}}async function C(){const e=await F();w(e)}function _(){I(),C(),h=setInterval(C,S)}function I(){h&&(clearInterval(h),h=null,w(null))}const i={authenticate:A,startPolling:_,stopPolling:I};var B={async onLoad(){await i.authenticate({success:!0})&&i.startPolling()},onUnload(){i.stopPolling(),l=null,p=!1},settings:$};return u.api=i,u.default=B,Object.defineProperty(u,"__esModule",{value:!0}),u})({},vendetta.metro.common,vendetta.metro,vendetta.plugin,vendetta.ui.toasts,vendetta.ui.components,vendetta.storage);
